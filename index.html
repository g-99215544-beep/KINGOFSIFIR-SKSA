<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juara Sifir SK Sri Aman</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Press Start 2P', cursive;
            background-color: #5c94fc; /* Warna langit Mario */
            color: #ffffff;
            text-shadow: 2px 2px #000000;
        }
        .screen {
            display: none;
        }
        .screen.active {
            display: block;
        }
        .retro-panel {
            background-color: #de6438; /* Warna blok tanah */
            border: 4px solid #000;
            padding: 2rem;
            box-shadow: 6px 6px 0px 0px rgba(0,0,0,1);
        }
        .retro-btn {
            background-color: #fcd834; /* Warna blok soalan */
            border: 4px solid #000;
            color: #000;
            text-shadow: none;
            padding: 1rem;
            box-shadow: 4px 4px 0px 0px rgba(0,0,0,1);
            transition: all 0.05s ease-in-out;
        }
        .retro-btn:hover {
            background-color: #ffe66e;
        }
        .retro-btn:active {
            transform: translate(4px, 4px);
            box-shadow: none;
        }
        .retro-btn-alt {
            background-color: #e0e0e0;
        }
         .retro-btn-alt:hover {
            background-color: #f0f0f0;
        }
        input[type="text"] {
            font-family: 'Press Start 2P', cursive;
            border: 4px solid #000;
            padding: 0.75rem;
            outline: none;
            box-shadow: 4px 4px 0px 0px rgba(0,0,0,0.5);
        }
        .heart {
            font-size: 2rem;
            text-shadow: 2px 2px #000000;
        }
        .feedback {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 1rem 2rem;
            font-size: 1.5rem;
            color: white;
            text-shadow: 3px 3px #000;
            opacity: 0;
            transition: all 0.5s ease-out;
            pointer-events: none;
            border: 4px solid black;
        }
        .feedback.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1.1);
        }
        .crown-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 1rem;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <div class="container mx-auto p-4 max-w-lg w-full">

        <!-- Skrin Mula -->
        <div id="start-screen" class="screen active text-center retro-panel">
            <svg class="crown-icon" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" fill="none">
                <path fill="#fcd834" d="M5 12l-2 15h26l-2-15-7 5-6-10-6 10-5-5z"/>
                <path fill="#000" d="M4 11h24v2H4zM2 27h28v2H2zM27 12v15h2V12zM3 12v15h2V12zM15 4h2v8h-2zM9 9h2v8H9zM21 9h2v8h-2z"/>
            </svg>
            <h1 class="text-2xl leading-tight mb-4">JUARA SIFIR<br>SK SRI AMAN</h1>
             <div id="top-player-display" class="bg-black bg-opacity-20 p-3 mb-6 text-sm h-16 flex items-center justify-center">
                Memuatkan juara...
            </div>
            <div class="space-y-4">
                <input type="text" id="player-name" placeholder="NAMA ANDA" class="w-full text-black">
                <input type="text" id="player-class" placeholder="KELAS ANDA" class="w-full text-black">
                <button id="start-btn" class="w-full retro-btn text-lg">MULA</button>
                <button id="view-ranking-start-btn" class="w-full retro-btn retro-btn-alt">PAPAN MARKAH</button>
            </div>
            <p id="auth-status" class="text-xs mt-4 opacity-70">Menyambung...</p>
        </div>

        <!-- Skrin Permainan -->
        <div id="game-screen" class="screen relative">
             <div class="retro-panel">
                <div class="flex justify-between items-center mb-4">
                    <div class="text-sm" id="game-player-name"></div>
                    <div id="lives" class="flex space-x-2"></div>
                </div>
                
                <div class="flex justify-between items-center mb-6 text-xl">
                     <div>Markah: <span id="score">0</span></div>
                     <div>Masa: <span id="time">60</span></div>
                </div>

                <div class="text-center my-8 bg-black bg-opacity-20 p-4">
                    <p id="question" class="text-6xl"></p>
                </div>
                
                <div id="answer-options" class="grid grid-cols-2 gap-4 mt-8">
                    <button class="answer-btn retro-btn text-3xl"></button>
                    <button class="answer-btn retro-btn text-3xl"></button>
                    <button class="answer-btn retro-btn text-3xl"></button>
                    <button class="answer-btn retro-btn text-3xl"></button>
                </div>
                
                <div class="w-full bg-black h-4 mt-8 border-2 border-black">
                    <div id="bonus-timer-bar" class="bg-yellow-400 h-full" style="width: 100%"></div>
                </div>
             </div>
            <div id="feedback-container"></div>
        </div>

        <!-- Skrin Tamat Permainan -->
        <div id="game-over-screen" class="screen text-center retro-panel">
            <h2 class="text-3xl mb-4">TAMAT!</h2>
            <p class="text-lg mb-4">MARKAH ANDA:</p>
            <p id="final-score" class="text-7xl mb-8">0</p>
            <div id="gemini-feedback-container" class="my-6 min-h-[6rem]">
                <button id="gemini-btn" class="w-full retro-btn text-base">✨ Komen Cikgu AI</button>
                <div id="gemini-loading" class="hidden">Memuatkan...</div>
                <p id="gemini-result" class="text-sm leading-relaxed text-left p-2 bg-black bg-opacity-20 hidden"></p>
            </div>
            <div class="space-y-4">
                 <button id="restart-btn" class="w-full retro-btn text-lg">MAIN SEMULA</button>
                 <button id="view-ranking-end-btn" class="w-full retro-btn retro-btn-alt">PAPAN MARKAH</button>
            </div>
        </div>

        <!-- Skrin Ranking -->
        <div id="ranking-screen" class="screen retro-panel">
            <h2 class="text-2xl mb-6 text-center">PAPAN MARKAH</h2>
            <div id="ranking-list" class="space-y-2 h-96 overflow-y-auto bg-black bg-opacity-20 p-2">
                <p class="text-center">Memuatkan...</p>
            </div>
            <button id="back-to-start-btn" class="w-full mt-6 retro-btn retro-btn-alt">KEMBALI</button>
        </div>
    </div>

    <script type="module">
        // Import fungsi-fungsi Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- PEMBOLEHUBAH GLOBAL & KONFIGURASI ---
        const screens = document.querySelectorAll('.screen');
        const startBtn = document.getElementById('start-btn');
        const restartBtn = document.getElementById('restart-btn');
        const viewRankingStartBtn = document.getElementById('view-ranking-start-btn');
        const viewRankingEndBtn = document.getElementById('view-ranking-end-btn');
        const backToStartBtn = document.getElementById('back-to-start-btn');
        
        const topPlayerDisplay = document.getElementById('top-player-display');
        const playerNameInput = document.getElementById('player-name');
        const playerClassInput = document.getElementById('player-class');
        const answerBtns = document.querySelectorAll('.answer-btn');
        
        const gamePlayerName = document.getElementById('game-player-name');
        const scoreDisplay = document.getElementById('score');
        const timeDisplay = document.getElementById('time');
        const livesDisplay = document.getElementById('lives');
        const questionDisplay = document.getElementById('question');
        const finalScoreDisplay = document.getElementById('final-score');
        const rankingList = document.getElementById('ranking-list');
        const bonusTimerBar = document.getElementById('bonus-timer-bar');

        const geminiBtn = document.getElementById('gemini-btn');
        const geminiLoading = document.getElementById('gemini-loading');
        const geminiResult = document.getElementById('gemini-result');

        const GAME_DURATION = 60;
        const MAX_LIVES = 2;
        const BONUS_TIME_LIMIT = 5;
        const COMBO_REQUIREMENT = 3;
        const QUESTION_TIME_LIMIT = 10;

        let score, lives, timeLeft, currentQuestion, questionStartTime, comboCounter;
        let gameInterval;
        let playerName, playerClass;
        let audioCtx;
        let questionTimeout;

        // --- FUNGSI AUDIO ---
        function initializeAudio() {
            if (!audioCtx) {
                try {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                } catch(e) { console.error("Web Audio API not supported."); }
            }
        }

        function playSound(type) {
            if (!audioCtx) return;
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);

            if (type === 'correct') { // Bunyi ala-ala kutip syiling
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(1046.50, audioCtx.currentTime); // C6
                gainNode.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.2);
            } else if (type === 'wrong') { // Bunyi "bump"
                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(110, audioCtx.currentTime); // A2
                gainNode.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.3);
            }
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + 0.3);
        }

        function handleTimeUp() {
            playSound('wrong');
            lives--;
            comboCounter = 0;
            showFeedback('MASA TAMAT!', 'bg-red-500');
            updateLivesDisplay();
            if (lives <= 0) {
                endGame();
                return;
            }
            generateQuestion();
        }

        // --- KONFIGURASI FIREBASE ---
        let db, auth;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'sifir-pantas-app';
        
        async function initializeFirebase() {
            try {
                const firebaseConfig = {
  apiKey: "AIzaSyDem01lvBz6pnQO2v97WhXe6mjQML4JQ3Q",
  authDomain: "king-of-sifir.firebaseapp.com",
  databaseURL: "https://king-of-sifir-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "king-of-sifir",
  storageBucket: "king-of-sifir.firebasestorage.app",
  messagingSenderId: "1062770360330",
  appId: "1:1062770360330:web:d0004ce218effbf5da1ff3",
  measurementId: "G-0FVQ446Z7H"
};
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                const authStatus = document.getElementById('auth-status');
                await signInAnonymously(auth);
                authStatus.textContent = "Tersambung!";
                fetchTopPlayer(); // Muatkan pemain terbaik selepas sambungan berjaya
            } catch (error) {
                console.error("Firebase Error:", error);
                const authStatus = document.getElementById('auth-status');
                authStatus.textContent = "Gagal Sambung.";
                topPlayerDisplay.innerHTML = "Gagal memuatkan ranking.";
            }
        }

        // --- FUNGSI UTAMA PERMAINAN ---
        function showScreen(screenId) {
            screens.forEach(screen => {
                screen.classList.toggle('active', screen.id === screenId);
            });
            if (screenId === 'start-screen') {
                fetchTopPlayer(); // Kemas kini pemain terbaik setiap kali kembali ke skrin utama
            }
        }

        function startGame() {
            initializeAudio();
            playerName = playerNameInput.value.trim().toUpperCase();
            playerClass = playerClassInput.value.trim().toUpperCase();

            if (!playerName || !playerClass) {
                alert("SILA ISI NAMA DAN KELAS.");
                return;
            }

            score = 0; lives = MAX_LIVES; timeLeft = GAME_DURATION; comboCounter = 0;
            
            updateDisplay();
            gamePlayerName.textContent = `${playerName}`;
            showScreen('game-screen');
            
            generateQuestion();
            gameInterval = setInterval(updateTimer, 1000);
        }

        function updateTimer() {
            timeLeft--;
            timeDisplay.textContent = timeLeft;
            if (timeLeft <= 0) endGame();
        }

        function generateQuestion() {
            clearTimeout(questionTimeout);
            const num1 = Math.floor(Math.random() * 9) + 1;
            const num2 = Math.floor(Math.random() * 9) + 1;
            currentQuestion = { num1, num2, answer: num1 * num2 };
            questionDisplay.textContent = `${num1}x${num2}`;
            
            const options = new Set([currentQuestion.answer]);
            while (options.size < 4) {
                const offset = Math.floor(Math.random() * 5) + 1;
                let wrongAnswer = currentQuestion.answer + (Math.random() > 0.5 ? offset : -offset);
                if (wrongAnswer > 0 && wrongAnswer !== currentQuestion.answer) options.add(wrongAnswer);
            }
            
            const shuffledOptions = Array.from(options).sort(() => Math.random() - 0.5);
            answerBtns.forEach((btn, i) => btn.textContent = shuffledOptions[i]);
            
            questionStartTime = Date.now();
            questionTimeout = setTimeout(handleTimeUp, QUESTION_TIME_LIMIT * 1000);
            
            bonusTimerBar.style.transition = 'none';
            bonusTimerBar.style.width = '100%';
            setTimeout(() => {
                bonusTimerBar.style.transition = `width ${QUESTION_TIME_LIMIT}s linear`;
                bonusTimerBar.style.width = '0%';
            }, 50);
        }

        function checkAnswer(e) {
            clearTimeout(questionTimeout);
            const userAnswer = parseInt(e.target.textContent, 10);
            const timeTaken = (Date.now() - questionStartTime) / 1000;

            if (userAnswer === currentQuestion.answer) {
                playSound('correct');
                score += 10;
                comboCounter++;
                showFeedback('BETUL!', 'bg-green-500');

                if (timeTaken < BONUS_TIME_LIMIT) {
                    score += 5;
                    showFeedback('BONUS!', 'bg-yellow-500', 500);
                }
                if (comboCounter > 0 && comboCounter % COMBO_REQUIREMENT === 0) {
                    score += 20;
                    showFeedback(`KOMBO!`, 'bg-sky-500', 1000);
                }
            } else {
                playSound('wrong');
                lives--;
                comboCounter = 0;
                showFeedback('SALAH!', 'bg-red-500');
                updateLivesDisplay();
                if (lives <= 0) {
                    endGame();
                    return;
                }
            }
            scoreDisplay.textContent = score;
            generateQuestion();
        }

        function endGame() {
            clearInterval(gameInterval);
            clearTimeout(questionTimeout);
            finalScoreDisplay.textContent = score;
            showScreen('game-over-screen');
            saveScoreToFirebase(playerName, playerClass, score);
        }
        
        function updateDisplay() {
            scoreDisplay.textContent = score;
            timeDisplay.textContent = timeLeft;
            updateLivesDisplay();
        }

        function updateLivesDisplay() {
            livesDisplay.innerHTML = '';
            for (let i = 0; i < lives; i++) {
                const heart = document.createElement('span');
                heart.className = 'heart';
                heart.textContent = '❤️';
                livesDisplay.appendChild(heart);
            }
        }

        function showFeedback(text, bgColor, delay = 0) {
            setTimeout(() => {
                const feedbackEl = document.createElement('div');
                feedbackEl.className = `feedback ${bgColor}`;
                feedbackEl.textContent = text;
                document.getElementById('feedback-container').appendChild(feedbackEl);
                setTimeout(() => feedbackEl.classList.add('show'), 10);
                setTimeout(() => {
                    feedbackEl.classList.remove('show');
                    setTimeout(() => feedbackEl.remove(), 500);
                }, 1000);
            }, delay);
        }
        
        async function fetchTopPlayer() {
             if (!db) return;
            try {
                const scoresCollection = collection(db, `artifacts/${appId}/public/data/scores`);
                const q = query(scoresCollection, orderBy("score", "desc"), limit(1));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    topPlayerDisplay.innerHTML = "Jadilah yang pertama mendapat markah tertinggi!";
                } else {
                    const topPlayer = querySnapshot.docs[0].data();
                    topPlayerDisplay.innerHTML = `JUARA SEMASA:<br>${topPlayer.name} - ${topPlayer.score}`;
                }
            } catch (error) {
                console.error("Error fetching top player:", error);
                topPlayerDisplay.innerHTML = "Gagal memuatkan ranking.";
            }
        }

        async function showRanking() {
            showScreen('ranking-screen');
            rankingList.innerHTML = '<p class="text-center">Memuatkan...</p>';

            try {
                const scoresCollection = collection(db, `artifacts/${appId}/public/data/scores`);
                const q = query(scoresCollection, orderBy("score", "desc"));
                const querySnapshot = await getDocs(q);
                let scores = [];
                querySnapshot.forEach(doc => scores.push(doc.data()));

                rankingList.innerHTML = '';
                if (scores.length === 0) {
                     rankingList.innerHTML = '<p class="text-center">Tiada Markah.</p>';
                } else {
                    scores.slice(0, 50).forEach((s, i) => { 
                        const rankItem = document.createElement('div');
                        rankItem.className = `p-2 flex justify-between items-center text-sm ${i % 2 === 0 ? 'bg-black bg-opacity-10' : ''}`;
                        rankItem.innerHTML = `
                            <div><span>${i + 1}.</span> ${s.name} (${s.playerClass})</div>
                            <div class="font-bold">${s.score}</div>`;
                        rankingList.appendChild(rankItem);
                    });
                }
            } catch (error) {
                console.error("Error fetching scores:", error);
                rankingList.innerHTML = '<p class="text-center">Gagal memuatkan.</p>';
            }
        }
        
        async function saveScoreToFirebase(name, playerClass, score) {
             if (!auth || !auth.currentUser) return;
            try {
                 await addDoc(collection(db, `artifacts/${appId}/public/data/scores`), {
                    name, playerClass, score, timestamp: new Date() });
            } catch (error) { console.error("Error saving score: ", error); }
        }

        // --- FUNGSI GEMINI API ---
        async function getGeminiFeedback(pName, pScore) {
            geminiBtn.classList.add('hidden');
            geminiLoading.classList.remove('hidden');
            geminiResult.classList.add('hidden');

            const apiKey = ""; // API key dikendalikan oleh persekitaran
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const systemPrompt = "Anda adalah seorang guru yang ceria dan bersemangat dengan gaya retro 8-bit. Berikan komen yang positif dan membina kepada murid berdasarkan markah permainan sifir mereka. Gunakan bahasa yang ringkas, menyeronokkan, dan ada unsur-unsur permainan video klasik seperti 'power-up', 'level up', atau 'high score'. Pastikan komen tidak lebih daripada 40 patah perkataan dan sapa murid dengan nama mereka.";
            const userQuery = `Nama murid: ${pName}, Markah: ${pScore}. Berikan komen.`;

            const payload = {
                systemInstruction: { parts: [{ text: systemPrompt }] },
                contents: [{ parts: [{ text: userQuery }] }],
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    geminiResult.textContent = text;
                } else {
                    geminiResult.textContent = "Maaf, Cikgu AI tidak dapat memberi komen sekarang. Cuba lagi nanti.";
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                geminiResult.textContent = "Gagal mendapatkan komen daripada Cikgu AI.";
            } finally {
                geminiLoading.classList.add('hidden');
                geminiResult.classList.remove('hidden');
            }
        }


        // --- EVENT LISTENERS ---
        startBtn.addEventListener('click', startGame);
        answerBtns.forEach(btn => btn.addEventListener('click', checkAnswer));
        restartBtn.addEventListener('click', () => {
            playerNameInput.value = '';
            playerClassInput.value = '';
            // Reset Gemini UI
            geminiBtn.classList.remove('hidden');
            geminiLoading.classList.add('hidden');
            geminiResult.classList.add('hidden');
            geminiResult.textContent = '';
            showScreen('start-screen');
        });
        viewRankingStartBtn.addEventListener('click', showRanking);
        viewRankingEndBtn.addEventListener('click', showRanking);
        backToStartBtn.addEventListener('click', () => showScreen('start-screen'));
        geminiBtn.addEventListener('click', () => getGeminiFeedback(playerName, score));
        
        window.onload = initializeFirebase;
    </script>
</body>
</html>

